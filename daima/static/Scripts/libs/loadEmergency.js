var iconLayer = [];


//显示应急疏散路线
function showEmergency(routeCoords, exit2) {
    //画出路线图
    var routeLength = routeCoords.length;
    ExpMapManager.drawLine(routeCoords);

    var geoMarker = new ol.Feature({
        type: 'geoMarker',
        geometry: new ol.geom.Point(routeCoords[0])
    });
    var startMarker = new ol.Feature({
        type: 'startMarker',
        geometry: new ol.geom.Point(routeCoords[0])
    });
    var endMarker = new ol.Feature({
        type: 'endMarker',
        geometry: new ol.geom.Point(routeCoords[routeLength - 1])
    });

    var styles = {
        'startMarker': new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                src: '../Scripts/images/my.png'
            })
        }),
        'endMarker': new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                src: '../Scripts/images/exit.png'
            })
        }),
        'geoMarker': new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                src: '../Scripts/images/people1.png'
            })
        })
    };

    if (exit2) {
        //换一下安全出口的图片
        styles = {
            'startMarker': new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: '../Scripts/images/my.png'
                })
            }),
            'endMarker': new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: '../Scripts/images/exit2.png'
                })
            }),
            'geoMarker': new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: '../Scripts/images/people1.png'
                })
            })
        };
    }

    var vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [geoMarker, startMarker, endMarker]
        }),
        style: function (feature) {
            return styles[feature.get('type')];
        }
    });
    map.addLayer(vectorLayer);


    //动画
    var animating = false;
    var speed = 2;
    var now;


    var moveFeature = function (event) {
        var vectorContext = event.vectorContext;
        var frameState = event.frameState;

        if (animating) {
            var elapsedTime = frameState.time - now;
            // here the trick to increase speed is to jump some indexes
            // on lineString coordinates
            var index = Math.round(speed * elapsedTime / 1000);

            if (index >= routeLength) {
                stopAnimation(true);
                startAnimation();
                return;
            }

            var currentPoint = new ol.geom.Point(routeCoords[index]);
            var feature = new ol.Feature(currentPoint);
            //map.getView().setCenter(routeCoords[index]);
            vectorContext.drawFeature(feature, styles.geoMarker);
        }
        // tell OpenLayers to continue the postcompose animation
        map.render();
    };

    function startAnimation() {
        if (animating) {
            stopAnimation(false);
        } else {
            animating = true;
            now = new Date().getTime();
            // hide geoMarker
            geoMarker.setStyle(null);
            // just in case you pan somewhere else
            //map.getView().setCenter(routeCoords[0]);
            map.on('postcompose', moveFeature);
            map.render();
        }
    }

    function stopAnimation(ended) {
        animating = false;

        // if animation cancelled set the marker at the beginning
        var coord = ended ? routeCoords[routeLength - 1] : routeCoords[0];
        (geoMarker.getGeometry()).setCoordinates(coord);
        //remove listener
        map.un('postcompose', moveFeature);
    }

    startAnimation();
}

//根据导览屏显示应急疏散路线
function loadRoute(screenNo) {
    var routeCoords = [];
    if (screenNo == "001") {
        //下左上右
        routeCoords = [[121.53630257284554, 31.271001663659668], [121.53598607218179, 31.27018627211914], [121.53558374082955, 31.269252863381958], [121.53486490881356, 31.268807616685486], [121.53486490881356, 31.268807616685486], [121.53436065351876, 31.267820563768005], [121.53460404939719, 31.267593616395757], [121.53460404939719, 31.267593616395757]];
        showEmergency(routeCoords);
        routeCoords = [[121.53630257284554, 31.271001663659668], [121.53545890557436, 31.271025994965303], [121.53481517541078, 31.27110646123575], [121.53537307488588, 31.27238855714487], [121.53413515653702, 31.27256558293985], [121.53300326433273, 31.272726515480745], [121.5320430335054, 31.27286599034952], [121.53173189725968, 31.27280698175119]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53630257284554, 31.271001663659668], [121.53665600011989, 31.27176910408027], [121.53632877062007, 31.272434291915964], [121.53562603185817, 31.272858080940317], [121.53614101598903, 31.273925600128244], [121.53614101598903, 31.273925600128244], [121.53654334734127, 31.27476781375892], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53630257284554, 31.271001663659668], [121.53664527128383, 31.271758375244207], [121.5368383903329, 31.272128520088263], [121.5377020616357, 31.272015867309637], [121.5377020616357, 31.272015867309637], [121.53770742605373, 31.27145260341651], [121.5384048003976, 31.271307764129705], [121.5384048003976, 31.271307764129705]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "002") {
        routeCoords = [[121.53547351613007, 31.271034091026426], [121.53627817883454, 31.27091227793855], [121.53598850026093, 31.270204174758618], [121.53568809285126, 31.269549715758984], [121.53554325356443, 31.269238579513264], [121.53492098107297, 31.268905985595417], [121.53443818345029, 31.267951119186115], [121.53435235276181, 31.26779018664522], [121.53460404939719, 31.267593616395757]];
        showEmergency(routeCoords);
        routeCoords = [[121.53547351613007, 31.271034091026426], [121.53481905713043, 31.271109192878843], [121.53514092221222, 31.271838753730894], [121.5353715921875, 31.272375195533872], [121.53408949627838, 31.272568314582944], [121.5331024433609, 31.27270778945172], [121.5320027376648, 31.272895544082765], [121.53176133885346, 31.272836535484437], [121.53176133885346, 31.272836535484437]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53547351613007, 31.271034091026426], [121.53481905713043, 31.271109192878843], [121.53514092221222, 31.271838753730894], [121.5353715921875, 31.272375195533872], [121.53582756772002, 31.27328178218091], [121.53582756772002, 31.27328178218091], [121.53637473835906, 31.274397581131105], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53547351613007, 31.271034091026426], [121.53627817883454, 31.27091227793855], [121.53662686600646, 31.27170463403695], [121.53683607830962, 31.272123058643274], [121.53771047844847, 31.27201040586465], [121.53769438519438, 31.27146323522561], [121.53839175953826, 31.271377404537134], [121.53839175953826, 31.271377404537134], [121.53838639512023, 31.271323760356836]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "003") {
        routeCoords = [[121.53596030011894, 31.271908897839218], [121.53666840329888, 31.27182306715074], [121.53629825845482, 31.27090038724962], [121.5359334780288, 31.270047444782882], [121.53557942643883, 31.269264239750534], [121.53487668767693, 31.268797535381943], [121.53439389005425, 31.26786949106279], [121.53460404939719, 31.267593616395757]];
        showEmergency(routeCoords);
        routeCoords = [[121.53596030011894, 31.271908897839218], [121.53524476731572, 31.272002917728457], [121.53540033543858, 31.27239452024463], [121.53412360394749, 31.272555452785525], [121.532954160817, 31.27272711416248], [121.53200465882573, 31.272866589031253], [121.53170961583409, 31.272796851596866], [121.53170961583409, 31.272796851596866]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53596030011894, 31.271908897839218], [121.53524476731572, 31.272002917728457], [121.53540033543858, 31.27239452024463], [121.53562603185817, 31.272858080940317], [121.53611916745456, 31.273880464038882], [121.5365054055527, 31.27464757581714], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53596030011894, 31.271908897839218], [121.53665659455882, 31.271820527515445], [121.53682289151774, 31.272104841671023], [121.53770802049266, 31.272008282146487], [121.53772411374675, 31.27143965383533], [121.53842685250865, 31.271278721294436], [121.53842685250865, 31.271278721294436], [121.53842685250865, 31.271278721294436]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "004") {
        routeCoords = [[121.53595588274071, 31.272587889581484], [121.53654060430596, 31.27214800730304], [121.53664252824852, 31.271740311532778], [121.53628847665856, 31.270860546975893], [121.53554282255242, 31.269213670640752], [121.53486154146263, 31.26881670370655], [121.53440556593009, 31.267856472879217], [121.53460404939719, 31.267593616395757]];
        showEmergency(routeCoords);
        routeCoords = [[121.53595588274071, 31.272587889581484], [121.53555147022377, 31.272693663896252], [121.53541199535499, 31.272382527650525], [121.53441421360145, 31.2725220025193], [121.533432525102, 31.272661477388073], [121.532171886865, 31.272838503183056], [121.53175882667671, 31.272800952256848], [121.53175882667671, 31.272800952256848]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53595588274071, 31.272587889581484], [121.53555147022377, 31.272693663896252], [121.53600057274829, 31.273632378958908], [121.53639217526447, 31.274426312827316], [121.53639217526447, 31.274426312827316], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53595588274071, 31.272587889581484], [121.53654060430596, 31.27214800730304], [121.53770645768176, 31.272006960295883], [121.53772791535388, 31.271416874312607], [121.53772791535388, 31.271416874312607], [121.53844674736987, 31.271288128279892], [121.53844674736987, 31.271288128279892], [121.53844674736987, 31.271288128279892]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "005") {
        routeCoords = [[121.53682701243766, 31.272366863691545], [121.53667514576874, 31.27181817678414], [121.53628354325257, 31.27085794595681],  [121.53553788914643, 31.269205705203635], [121.53485124363861, 31.268792645015342], [121.53440063252411, 31.26786460069619], [121.53463130249939, 31.26758565095864]];
        showEmergency(routeCoords);
        routeCoords = [[121.53682701243766, 31.272366863691545], [121.53553418769248, 31.272667271101213], [121.53540007724173, 31.272382956945634], [121.53412871016867, 31.272565347158647], [121.53300754680045, 31.27272091528151], [121.532025858301, 31.2728818478224], [121.5317200864733, 31.272779923879835]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53682701243766, 31.272366863691545], [121.53554387643523, 31.272671400188727], [121.53602667405791, 31.273712097286506], [121.53648801400847, 31.274661599277778], [121.53648801400847, 31.274661599277778], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53682701243766, 31.272366863691545], [121.53685217156372, 31.272123067886486], [121.53770511403046, 31.27201041510786], [121.53771584286652, 31.271431057960644], [121.53844540371857, 31.27127548983778], [121.53844540371857, 31.27127548983778], [121.53844540371857, 31.27127548983778]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "006") {
        routeCoords = [[121.53517522173365, 31.27263621946153], [121.53550245123347, 31.27260939737138], [121.53518595056971, 31.271928116281597], [121.53426863508662, 31.26981989999589], [121.53522350149592, 31.269691153963176], [121.53486408548792, 31.268795296152202], [121.53441883879145, 31.26788870950517], [121.53462268667658, 31.26758293767747]];
        showEmergency(routeCoords);
        routeCoords = [[121.53517522173365, 31.27263621946153], [121.535146909501, 31.272435365795413], [121.53431006028835, 31.27254265415601], [121.53341420247737, 31.272655306934634], [121.53230913236322, 31.272816239475528], [121.53202481820765, 31.272859154819766], [121.53176196172419, 31.27278941738538], [121.53176196172419, 31.27278941738538]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53517522173365, 31.27263621946153], [121.53550245123347, 31.27260939737138], [121.53584428384485, 31.273336588024417], [121.53584428384485, 31.273336588024417], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53517522173365, 31.27263621946153], [121.53550245123347, 31.27260939737138], [121.53650954604213, 31.272381970438097], [121.53684213995997, 31.272108385118578], [121.5377111756808, 31.272006461176012], [121.53771654009883, 31.271448561700915], [121.53844073653285, 31.27128762916002], [121.53844073653285, 31.27128762916002]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "007") {
        routeCoords = [[121.53553788914638, 31.27334615519728], [121.53584366097408, 31.273303239853043], [121.53540914311367, 31.27240738204207], [121.53510337128597, 31.271752923042435], [121.53439526810604, 31.270283072502274], [121.53421824231106, 31.26987537673201], [121.53488879456478, 31.26883467963423],[121.53462057366329, 31.26761695674147]];
        showEmergency(routeCoords);
        routeCoords = [[121.53553788914638, 31.27334615519728], [121.53584366097408, 31.273303239853043], [121.53538768544159, 31.272391288787972], [121.53401439442592, 31.27258440783705], [121.53315608754116, 31.272697060615677], [121.53211539044338, 31.27282580664839], [121.53171305909115, 31.272788255722183], [121.53171305909115, 31.272788255722183]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53553788914638, 31.27334615519728], [121.53584366097408, 31.273303239853043], [121.53620377421443, 31.27404962324942], [121.5365041816241, 31.274682624576936], [121.53681531786982, 31.27531562590445], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53553788914638, 31.27334615519728], [121.53584366097408, 31.273303239853043], [121.53560762658078, 31.272825806648395], [121.53632109417875, 31.27242883971419], [121.53681998505552, 31.272123067886493], [121.53771047844846, 31.272021143943928], [121.53771584286649, 31.27146860888686], [121.53844003930051, 31.271296947509907]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "008") {
        routeCoords = [[121.53524254345292, 31.274117638900197], [121.53614376568193, 31.273945977523244], [121.5356019594609, 31.27278726322881], [121.53500650905961, 31.27154808266393], [121.53463099979753, 31.270668318107045], [121.53519962810869, 31.269681265189565], [121.53492067837114, 31.268938676465154], [121.53438423656816, 31.26779605542481], [121.53461490654344, 31.267602936375738]];
        showEmergency(routeCoords);
        routeCoords = [[121.53524254345292, 31.274117638900197], [121.53614376568193, 31.273945977523244], [121.5356019594609, 31.27278726322881], [121.5353820183217, 31.272384931876577], [121.53416965984697, 31.2725512288355], [121.53307531856889, 31.272717525794423], [121.53214190983171, 31.272862365081227], [121.5317073919713, 31.27276580555669], [121.5317073919713, 31.27276580555669]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53524254345292, 31.274117638900197], [121.53614376568193, 31.273945977523244], [121.5365353681981, 31.274734546973622], [121.5365353681981, 31.274734546973622], [121.5365353681981, 31.274734546973622], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53524254345292, 31.274117638900197], [121.53614376568193, 31.273945977523244], [121.5356019594609, 31.27278726322881], [121.53643344425552, 31.272379567458547], [121.53771017574661, 31.272004058196462], [121.53769944691055, 31.271467616393483], [121.53769944691055, 31.271467616393483], [121.53845582985275, 31.2712905905985], [121.53845582985275, 31.2712905905985]];
        showEmergency(routeCoords);
    }
    else if (screenNo == "009") {
        routeCoords = [[121.53687362923584, 31.272160618812688], [121.53667514576874, 31.27181817678414], [121.53628354325257, 31.27085794595681], [121.53553788914643, 31.269205705203635], [121.53485124363861, 31.268792645015342], [121.53440063252411, 31.26786460069619], [121.53463130249939, 31.26758565095864]];
        showEmergency(routeCoords);
        routeCoords = [[121.53687362923584, 31.272160618812688], [121.53553418769248, 31.272667271101213], [121.53540007724173, 31.272382956945634], [121.53412871016867, 31.272565347158647], [121.53300754680045, 31.27272091528151], [121.532025858301, 31.2728818478224], [121.5317200864733, 31.272779923879835]];
        showEmergency(routeCoords, true);
        routeCoords = [[121.53687362923584, 31.272160618812688], [121.53554387643523, 31.272671400188727], [121.53602667405791, 31.273712097286506], [121.53648801400847, 31.274661599277778], [121.53648801400847, 31.274661599277778], [121.53661828558194, 31.27493166893646], [121.53661828558194, 31.27493166893646]];
        showEmergency(routeCoords);
        routeCoords = [[121.53687362923584, 31.272160618812688], [121.53685217156372, 31.272123067886486], [121.53770511403046, 31.27201041510786], [121.53771584286652, 31.271431057960644], [121.53844540371857, 31.27127548983778], [121.53844540371857, 31.27127548983778], [121.53844540371857, 31.27127548983778]];
        showEmergency(routeCoords);
    }
}


//获取出口的信息
function loadExitInfo(msg1, msg2, msg3, msg4) {
    var msgdata = eval(msg1.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&#39;/g, "'"))[0];
    var strMsg = "<font color=red><strong>南门出入口（长阳路）</strong></font><br/>";
    strMsg += "<strong>地铁站：</strong><br/>";
    strMsg += msgdata.NearbyMetroInfor.replace(/；/g, "；<br/>");
    strMsg += "<br/><strong>公交站：</strong><br/>";
    strMsg += msgdata.NearbyBusInfor.replace(/；/g, "；<br/>");
    $("#msg_banner1 p").html(strMsg);

    var msgdata = eval(msg2.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&#39;/g, "'"))[0];
    var strMsg = "<font color=red><strong>西门出入口（黄兴路）</strong></font><br/>";
    strMsg += "<strong>地铁站：</strong><br/>";
    strMsg += msgdata.NearbyMetroInfor.replace(/；/g, "；<br/>");
    strMsg += "<br/><strong>公交站：</strong><br/>";
    strMsg += msgdata.NearbyBusInfor.replace(/；/g, "；<br/>");
    $("#msg_banner2 p").html(strMsg);

    var msgdata = eval(msg3.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&#39;/g, "'"))[0];
    var strMsg = "<font color=red><strong>北门出入口（周家嘴路）</strong></font><br/>";
    strMsg += "<strong>地铁站：</strong><br/>";
    strMsg += msgdata.NearbyMetroInfor.replace(/；/g, "；<br/>");
    strMsg += "<br/><strong>公交站：</strong><br/>";
    strMsg += msgdata.NearbyBusInfor.replace(/；/g, "；<br/>");
    $("#msg_banner3 p").html(strMsg);

    var msgdata = eval(msg4.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&#39;/g, "'"))[0];
    var strMsg = "<font color=red><strong>东门出入口（双阳路）</strong></font><br/>";
    strMsg += "<strong>地铁站：</strong><br/>";
    strMsg += msgdata.NearbyMetroInfor.replace(/；/g, "；<br/>");
    strMsg += "<br/><strong>公交站：</strong><br/>";
    strMsg += msgdata.NearbyBusInfor.replace(/；/g, "；<br/>");
    $("#msg_banner4 p").html(strMsg);




    showExitInfo(document.getElementById('msg1'), [121.5343048980642, 31.26754433008296]);
    showExitInfo(document.getElementById('msg2'), [121.52854268803559, 31.274345725090154]);
    showExitInfo(document.getElementById('msg3'), [121.5362889076706, 31.277500002891667]);
    showExitInfo(document.getElementById('msg4'), [121.53893893017731, 31.27240380576337]);
}



//加载Poi
function loadPoi(id) {
    $.post("../Poi/LoadPoi", { Type: id }, function (data) {
        if (data.IsSuccess == true) {

            var json = eval('[' + data.Message.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&#39;/g, "'") + ']')[0];
            if (json.total > 0) {
                iconLayer[id] = new ol.layer.Vector({ zIndex: 999 });

                var icon = '../Scripts/images/' + json.data[0].mvU_Icon;
                var poidatas = [];
                $.each(json.data, function (index, d) {//debugger;
                    var data = {
                        data: { type: d.mvU_Type, id: d.id, name: d.mvU_Name, x: d.mvU_X, y: d.mvU_Y, url: d.mvU_Url }, style: { icon: '../Scripts/images/' + d.mvU_Icon, anchor: [0.5, 1], name: d.mvU_Name }
                    };
                    poidatas.push(data);
                });
                ExpMapManager.Draw.drawIcon({
                    layer: iconLayer[id], properties: poidatas, style: { icon: icon, anchor: [0.5, 1] }
                });
            }
        }
    });
}

//移除Poi
function removePoi(id) {
    var img = ('../Scripts/images/icogray_' + id + '.png');
    $(".pio_list ul li").eq(id).css('background-image', ('url("' + img + '")'));
    iconLayer[id].setSource(null);
    map.removeLayer(iconLayer[id]);
}